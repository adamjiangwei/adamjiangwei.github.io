<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>文章发布与留言板（图片预览版）</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#000; }
  header { background:#333; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:20px; }
  .menu { position:relative; }
  .menu > button { background:#444; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:4px; margin-left:5px; }
  .dropdown { display:none; position:absolute; right:0; top:40px; background:#fff; color:#333; min-width:200px; padding:15px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  .dropdown input { width:100%; padding:6px; margin:6px 0; border:1px solid #ccc; border-radius:4px; }
  .dropdown button { width:100%; padding:8px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  .container { padding:20px; max-width:800px; margin:auto; }
  #postForm { display:none; background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  #postForm textarea { width:100%; height:80px; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
  #postForm button { padding:8px 16px; border:none; background:#28a745; color:#fff; border-radius:4px; cursor:pointer; }
  #preview img { max-width:150px; max-height:150px; margin:5px; border-radius:6px; display:inline-block; }
  .post { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .post time { color:#888; font-size:12px; }
  .post .actions button { margin-right:6px; padding:4px 8px; font-size:12px; border:none; border-radius:4px; cursor:pointer; }
  .post .actions .delete { background:#dc3545; color:#fff; }
  .post .actions .edit { background:#ffc107; color:#000; }
  .attachments img { max-width:200px; margin:5px; border-radius:6px; display:block; }
  .attachments a { display:block; color:#007bff; text-decoration:none; margin:2px 0; }
  .comments { margin-top:15px; padding-top:10px; border-top:1px solid #ddd; }
  .comment { font-size:14px; padding:6px 0; border-bottom:1px dashed #ddd; }
  .comment:last-child { border-bottom:none; }
  .comment-form input { width:80%; padding:6px; border:1px solid #ccc; border-radius:4px; }
  .comment-form button { padding:6px 12px; margin-left:5px; border:none; background:#007bff; color:#fff; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>
<header>
  <h1>文章发布板</h1>
  <div class="menu">
    <button onclick="toggleDropdown()">登录</button>
    <div class="dropdown" id="loginBox">
      <input type="text" id="username" placeholder="账号">
      <input type="password" id="password" placeholder="密码">
      <button onclick="login()">登录</button>
    </div>
  </div>
</header>
<div class="container">
  <div id="postForm">
    <textarea id="postContent" placeholder="写点什么..."></textarea><br>
    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.zip"><br>
    <div id="preview"></div><br>
    <button onclick="publishPost()">发布</button>
  </div>
  <div id="posts"></div>
</div>
<script>
const loginBox = document.getElementById("loginBox");
const postForm = document.getElementById("postForm");
const postsDiv = document.getElementById("posts");
const previewDiv = document.getElementById("preview");
let loggedIn = false;

function toggleDropdown(){ loginBox.style.display = loginBox.style.display==="block"?"none":"block"; }

function login(){
  const u=document.getElementById("username").value;
  const p=document.getElementById("password").value;
  if(u&&p){ alert("登录成功:"+u); loginBox.style.display="none"; postForm.style.display="block"; loggedIn=true;} 
  else alert("请输入账号和密码");
}

// 预览图片
document.getElementById("fileInput").addEventListener("change", function(){
  previewDiv.innerHTML="";
  Array.from(this.files).forEach(f=>{
    if(f.type.startsWith("image/")){
      let reader = new FileReader();
      reader.onload = e => { let img = document.createElement("img"); img.src=e.target.result; previewDiv.appendChild(img); };
      reader.readAsDataURL(f);
    }
  });
});

function publishPost(){
  if(!loggedIn){ alert("请先登录"); return; }
  let content=document.getElementById("postContent").value.trim();
  let files=document.getElementById("fileInput").files;
  if(!content && !files.length) return;

  let attachments=[];
  if(files.length){
    let count=0;
    Array.from(files).forEach(f=>{
      let reader=new FileReader();
      reader.onload=function(e){
        attachments.push({name:f.name, data:e.target.result});
        count++;
        if(count===files.length) savePost(content, attachments);
      };
      reader.readAsDataURL(f);
    });
  } else savePost(content, []);
}

function savePost(content, attachments){
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  posts.unshift({content:content, time:Date.now(), comments:[], attachments:attachments});
  localStorage.setItem("posts",JSON.stringify(posts));
  document.getElementById("postContent").value="";
  document.getElementById("fileInput").value="";
  previewDiv.innerHTML="";
  renderPosts();
}

function renderPosts(){
  postsDiv.innerHTML="";
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  posts.forEach(post=>{
    let div=document.createElement("div");
    div.className="post";
    div.innerHTML=`
      <div class="content">${post.content}</div>
      <div class="attachments">
        ${post.attachments.map(a=>{
          if(a.data.startsWith("data:image")) return `<img src="${a.data}" alt="${a.name}">`;
          else return `<a href="${a.data}" download="${a.name}">${a.name}</a>`;
        }).join("")}
      </div>
      <time>${new Date(post.time).toLocaleString()}</time>
      <div class="actions">
        <button class="edit" onclick="editPost(${post.time})">编辑</button>
        <button class="delete" onclick="deletePost(${post.time})">删除</button>
      </div>
      <div class="comments">
        ${post.comments.map(c=>`<div class="comment">${c}</div>`).join("")}
        <div class="comment-form">
          <input type="text" id="cmt-${post.time}" placeholder="匿名留言">
          <button onclick="addComment(${post.time})">提交</button>
        </div>
      </div>`;
    postsDiv.appendChild(div);
  });
}

function addComment(time){
  let input=document.getElementById("cmt-"+time);
  let txt=input.value.trim();
  if(!txt) return;
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  let post=posts.find(p=>p.time===time);
  if(post){ post.comments.push(txt); localStorage.setItem("posts",JSON.stringify(posts)); renderPosts(); }
}

function deletePost(time){
  if(!confirm("确认删除文章?")) return;
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  posts=posts.filter(p=>p.time!==time);
  localStorage.setItem("posts",JSON.stringify(posts));
  renderPosts();
}

function editPost(time){
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  let post=posts.find(p=>p.time===time);
  if(post){
    let newContent=prompt("编辑文章内容:",post.content);
    if(newContent!==null){ post.content=newContent.trim(); localStorage.setItem("posts",JSON.stringify(posts)); renderPosts(); }
  }
}

renderPosts();
</script>
</body>
</html>
